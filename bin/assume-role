#!/bin/bash

uaws()
{
	unset AWS_ACCESS_KEY_ID
	unset AWS_SECRET_ACCESS_KEY
	unset AWS_SESSION_TOKEN
	unset AWS_EXPIRATION
}

uaws

temp_role=$(aws --profile $1 sts assume-role --serial-number $2 --role-arn $3 --token-code $4   --role-session-name AssumedRole  --duration-seconds 7200  )
#echo $temp_role

expiration=$(echo $temp_role | jq -r .Credentials.Expiration |   xargs -I{} date -d {} +%s)
access_key=$(echo $temp_role | jq -r .Credentials.AccessKeyId)
secret=$(echo $temp_role | jq -r .Credentials.SecretAccessKey)
token=$(echo $temp_role | jq -r .Credentials.SessionToken)

echo "Expires: $(echo $temp_role | jq -r .Credentials.Expiration | xargs -I{} date -d {})"

aws configure set  aws_session_token $token --profile mfa
aws configure set  aws_secret_access_key $secret --profile mfa
aws configure set  aws_access_key_id  $access_key --profile  mfa
